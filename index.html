<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>애플스토어 아이폰 17 화이트 256GB 재고 확인 (강남/여의도)</title>
  <style>
    :root { --bg:#0b0c10; --card:#15171c; --text:#e8eaed; --muted:#aab2c0; --ok:#1db954; --warn:#f4b400; --bad:#ff5252; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:760px; margin:32px auto; padding:0 16px; }
    h1 { font-size:1.25rem; margin:0 0 16px; }
    .card { background:var(--card); border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .row > * { flex:1 1 220px; }
    label { display:block; font-size:.85rem; color:var(--muted); margin-bottom:6px; }
    input, select, button { width:100%; padding:12px; border-radius:12px; border:1px solid #2a2f3a; background:#0f1116; color:var(--text); outline:none; }
    input::placeholder { color:#5b6472; }
    button { background:#2d6cdf; border:none; cursor:pointer; font-weight:600; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .hint { font-size:.85rem; color:var(--muted); margin:8px 0 0; }
    .results { margin-top:16px; display:grid; grid-template-columns:1fr; gap:12px; }
    .store { background:#0f1116; border:1px solid #2a2f3a; border-radius:14px; padding:14px; display:flex; justify-content:space-between; align-items:center; }
    .store h3 { margin:0 0 4px; font-size:1rem; }
    .store .addr { font-size:.85rem; color:var(--muted); }
    .badge { font-weight:700; padding:8px 10px; border-radius:999px; }
    .ok { background:rgba(29,185,84,.15); color:var(--ok); border:1px solid rgba(29,185,84,.35); }
    .warn { background:rgba(244,180,0,.15); color:var(--warn); border:1px solid rgba(244,180,0,.35); }
    .bad { background:rgba(255,82,82,.15); color:var(--bad); border:1px solid rgba(255,82,82,.35); }
    .small { font-size:.85rem; color:var(--muted); margin-top:6px; }
    .footer { margin-top:20px; font-size:.8rem; color:#7f8794; }
    .footer a { color:#9bbcff; text-decoration:none; }
    .err { color:#ff8383; font-size:.9rem; margin-top:10px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>강남 / 여의도 애플스토어 — 아이폰 17 화이트 256GB 재고 확인</h1>
    <div class="card">
      <div class="row">
        <div>
          <label>부품번호(SKU) <span style="color:#7f8794">(예: MTxxxxKH/A)</span></label>
          <input id="sku" placeholder="아이폰 17 화이트 256GB의 부품번호를 입력" />
          <div class="hint">TIP: 애플 구매 페이지 URL의 <code>parts.0=</code> 값이 SKU입니다.</div>
        </div>
        <div>
          <label>검색 위치</label>
          <input id="location" value="서울" />
          <div class="hint">예: 서울, 강남구, 여의도</div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>국가/스토어 도메인</label>
          <select id="domain">
            <option value="https://www.apple.com/kr">한국 (apple.com/kr)</option>
            <option value="https://www.apple.com">미국 (apple.com)</option>
            <option value="https://www.apple.com/jp">일본 (apple.com/jp)</option>
          </select>
        </div>
        <div style="align-self:flex-end;">
          <button id="checkBtn">재고 확인</button>
        </div>
      </div>

      <div id="error" class="err" style="display:none;"></div>
      <div id="results" class="results" aria-live="polite"></div>
      <div class="footer">
        GitHub Pages는 정적 호스팅이라 브라우저에서 CORS로 막힙니다. 아래 <b>PROXY_BASE</b>에 배포한 프록시 주소를 넣어 사용하세요.
      </div>
    </div>
  </div>

  <script>
    // ✅ 여기를 당신의 프록시 주소로 바꾸세요.
    // Cloudflare Workers: "https://<your-subdomain>.workers.dev"
    // Netlify 함수: "https://<site>.netlify.app/.netlify/functions/proxy"
    const PROXY_BASE = "https://your-subdomain.workers.dev";

    const TARGET_STORES = ["Apple 강남", "Apple 여의도"];
    const $ = (sel) => document.querySelector(sel);
    const resultsEl = $("#results");
    const errEl = $("#error");
    const btn = $("#checkBtn");

    function badge(status, text) {
      const span = document.createElement("span");
      span.className = "badge " + (status === "ok" ? "ok" : status === "warn" ? "warn" : "bad");
      span.textContent = text;
      return span;
    }

    function normalizeStatus(pa) {
      const d = (pa?.pickupDisplay || "").toLowerCase();
      if (d.includes("available")) return { key:"ok", label:"픽업 가능" };
      if (d.includes("unavailable")) return { key:"bad", label:"품절" };
      if (d.includes("ineligible")) return { key:"bad", label:"해당 없음" };
      if (d.includes("soon") || d.includes("ship") || d.includes("limited")) return { key:"warn", label:"제한적/곧 입고" };
      return { key:"warn", label: pa?.pickupDisplay || "상태 확인" };
    }

    async function checkStock() {
      errEl.style.display = "none";
      errEl.textContent = "";
      resultsEl.innerHTML = "";

      const sku = $("#sku").value.trim();
      const loc = $("#location").value.trim() || "서울";
      const domain = $("#domain").value;

      if (!sku) {
        errEl.style.display = "block";
        errEl.textContent = "부품번호(SKU)를 입력하세요. (예: MT****KH/A)";
        return;
      }

      btn.disabled = true;
      btn.textContent = "조회 중…";

      try {
        const url = new URL("/shop/fulfillment-messages", domain);
        url.searchParams.set("pl", "true");
        url.searchParams.set("searchNearby", "true");
        url.searchParams.set("mts.0", "regular");
        url.searchParams.set("location", loc);
        url.searchParams.set("parts.0", sku);

        // ✅ 프록시 경유로 우회 (CORS 회피)
        const appleURL = url.toString();
        const proxyURL =
          PROXY_BASE.includes("workers.dev")
            ? `${PROXY_BASE}/?url=` + encodeURIComponent(appleURL)   // Cloudflare Workers
            : `${PROXY_BASE}?url=` + encodeURIComponent(appleURL);   // Netlify/Vercel 등

        const res = await fetch(proxyURL, { method: "GET" });
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`요청 실패 (${res.status}).\n${txt || ""}`);
        }
        const data = await res.json();

        const stores = data?.body?.content?.pickupMessage?.stores || [];
        if (!stores.length) {
          resultsEl.innerHTML = `<div class="small">해당 SKU 또는 위치로 조회된 매장이 없습니다.</div>`;
          return;
        }

        const target = stores.filter(s => TARGET_STORES.some(k => (s.storeName || "").includes(k)));
        if (!target.length) {
          resultsEl.innerHTML = `<div class="small">강남/여의도 매장이 검색 반경에 없어요. 위치를 "서울" 등으로 바꿔 보세요.</div>`;
          return;
        }

        target.forEach(store => {
          const wrap = document.createElement("div");
          wrap.className = "store";

          const left = document.createElement("div");
          const name = document.createElement("h3");
          name.textContent = store.storeName || "매장명 미확인";
          const addr = document.createElement("div");
          addr.className = "addr";
          addr.textContent = store.address?.address || store.address?.address1 || "";
          left.appendChild(name);
          left.appendChild(addr);

          const right = document.createElement("div");
          const pa = store.partsAvailability?.[sku];
          const st = normalizeStatus(pa);
          right.appendChild(badge(st.key, st.label));
          if (pa?.pickupSearchQuote) {
            const quote = document.createElement("div");
            quote.className = "small";
            quote.textContent = pa.pickupSearchQuote;
            right.appendChild(quote);
          }

          wrap.appendChild(left);
          wrap.appendChild(right);
          resultsEl.appendChild(wrap);
        });

      } catch (e) {
        errEl.style.display = "block";
        errEl.textContent = String(e?.message || e);
      } finally {
        btn.disabled = false;
        btn.textContent = "재고 확인";
      }
    }

    document.getElementById("checkBtn").addEventListener("click", checkStock);
    ["sku","location"].forEach(id=>{
      document.getElementById(id).addEventListener("keydown", (ev)=>{
        if (ev.key === "Enter") checkStock();
      });
    });
  </script>
</body>
</html>
